;;; examples/global-info.lisp - Grab info of all interfaces and shm formats
;;;
;;; Copyright (c) 2022 Samuel Hunter <samuel (at) shunter <dot> xyz>
;;; All rights reserved.

(defpackage #:xyz.shunter.wayflan.examples.global-info
  (:use #:cl #:wayflan-client)
  (:local-nicknames (#:a #:alexandria))
  (:export #:run))

(in-package #:xyz.shunter.wayflan.examples.global-info)



(defun handle-shm (&rest event)
  (event-case event
    (:format (format)
     (format t "~S~%"
       (a:switch (format :test #'=)
         (+wl-shm.format-argb8888+ :argb8888)
         (+wl-shm.format-xrgb8888+ :xrgb8888)
         (+wl-shm.format-c8+ :c8)
         (+wl-shm.format-rgb332+ :rgb332)
         (+wl-shm.format-bgr233+ :bgr233)
         (+wl-shm.format-xrgb4444+ :xrgb4444)
         (+wl-shm.format-xbgr4444+ :xbgr4444)
         (+wl-shm.format-rgbx4444+ :rgbx4444)
         (+wl-shm.format-bgrx4444+ :bgrx4444)
         (+wl-shm.format-argb4444+ :argb4444)
         (+wl-shm.format-abgr4444+ :abgr4444)
         (+wl-shm.format-rgba4444+ :rgba4444)
         (+wl-shm.format-bgra4444+ :bgra4444)
         (+wl-shm.format-xrgb1555+ :xrgb1555)
         (+wl-shm.format-xbgr1555+ :xbgr1555)
         (+wl-shm.format-rgbx5551+ :rgbx5551)
         (+wl-shm.format-bgrx5551+ :bgrx5551)
         (+wl-shm.format-argb1555+ :argb1555)
         (+wl-shm.format-abgr1555+ :abgr1555)
         (+wl-shm.format-rgba5551+ :rgba5551)
         (+wl-shm.format-bgra5551+ :bgra5551)
         (+wl-shm.format-rgb565+ :rgb565)
         (+wl-shm.format-bgr565+ :bgr565)
         (+wl-shm.format-rgb888+ :rgb888)
         (+wl-shm.format-bgr888+ :bgr888)
         (+wl-shm.format-xbgr8888+ :xbgr8888)
         (+wl-shm.format-rgbx8888+ :rgbx8888)
         (+wl-shm.format-bgrx8888+ :bgrx8888)
         (+wl-shm.format-abgr8888+ :abgr8888)
         (+wl-shm.format-rgba8888+ :rgba8888)
         (+wl-shm.format-bgra8888+ :bgra8888)
         (+wl-shm.format-xrgb2101010+ :xrgb2101010)
         (+wl-shm.format-xbgr2101010+ :xbgr2101010)
         (+wl-shm.format-rgbx1010102+ :rgbx1010102)
         (+wl-shm.format-bgrx1010102+ :bgrx1010102)
         (+wl-shm.format-argb2101010+ :argb2101010)
         (+wl-shm.format-abgr2101010+ :abgr2101010)
         (+wl-shm.format-rgba1010102+ :rgba1010102)
         (+wl-shm.format-bgra1010102+ :bgra1010102)
         (+wl-shm.format-yuyv+ :yuyv)
         (+wl-shm.format-yvyu+ :yvyu)
         (+wl-shm.format-uyvy+ :uyvy)
         (+wl-shm.format-vyuy+ :vyuy)
         (+wl-shm.format-ayuv+ :ayuv)
         (+wl-shm.format-nv12+ :nv12)
         (+wl-shm.format-nv21+ :nv21)
         (+wl-shm.format-nv16+ :nv16)
         (+wl-shm.format-nv61+ :nv61)
         (+wl-shm.format-yuv410+ :yuv410)
         (+wl-shm.format-yvu410+ :yvu410)
         (+wl-shm.format-yuv411+ :yuv411)
         (+wl-shm.format-yvu411+ :yvu411)
         (+wl-shm.format-yuv420+ :yuv420)
         (+wl-shm.format-yvu420+ :yvu420)
         (+wl-shm.format-yuv422+ :yuv422)
         (+wl-shm.format-yvu422+ :yvu422)
         (+wl-shm.format-yuv444+ :yuv444)
         (+wl-shm.format-yvu444+ :yvu444)
         (+wl-shm.format-r8+ :r8)
         (+wl-shm.format-r16+ :r16)
         (+wl-shm.format-rg88+ :rg88)
         (+wl-shm.format-gr88+ :gr88)
         (+wl-shm.format-rg1616+ :rg1616)
         (+wl-shm.format-gr1616+ :gr1616)
         (+wl-shm.format-xrgb16161616f+ :xrgb16161616f)
         (+wl-shm.format-xbgr16161616f+ :xbgr16161616f)
         (+wl-shm.format-argb16161616f+ :argb16161616f)
         (+wl-shm.format-abgr16161616f+ :abgr16161616f)
         (+wl-shm.format-xyuv8888+ :xyuv8888)
         (+wl-shm.format-vuy888+ :vuy888)
         (+wl-shm.format-vuy101010+ :vuy101010)
         (+wl-shm.format-y210+ :y210)
         (+wl-shm.format-y212+ :y212)
         (+wl-shm.format-y216+ :y216)
         (+wl-shm.format-y410+ :y410)
         (+wl-shm.format-y412+ :y412)
         (+wl-shm.format-y416+ :y416)
         (+wl-shm.format-xvyu2101010+ :xvyu2101010)
         (+wl-shm.format-xvyu12-16161616+ :xvyu12-16161616)
         (+wl-shm.format-xvyu16161616+ :xvyu16161616)
         (+wl-shm.format-y0l0+ :y0l0)
         (+wl-shm.format-x0l0+ :x0l0)
         (+wl-shm.format-y0l2+ :y0l2)
         (+wl-shm.format-x0l2+ :x0l2)
         (+wl-shm.format-yuv420-8bit+ :yuv420-8bit)
         (+wl-shm.format-yuv420-10bit+ :yuv420-10bit)
         (+wl-shm.format-xrgb8888-a8+ :xrgb8888-a8)
         (+wl-shm.format-xbgr8888-a8+ :xbgr8888-a8)
         (+wl-shm.format-rgbx8888-a8+ :rgbx8888-a8)
         (+wl-shm.format-bgrx8888-a8+ :bgrx8888-a8)
         (+wl-shm.format-rgb888-a8+ :rgb888-a8)
         (+wl-shm.format-bgr888-a8+ :bgr888-a8)
         (+wl-shm.format-rgb565-a8+ :rgb565-a8)
         (+wl-shm.format-bgr565-a8+ :bgr565-a8)
         (+wl-shm.format-nv24+ :nv24)
         (+wl-shm.format-nv42+ :nv42)
         (+wl-shm.format-p210+ :p210)
         (+wl-shm.format-p010+ :p010)
         (+wl-shm.format-p012+ :p012)
         (+wl-shm.format-p016+ :p016)
         (+wl-shm.format-axbxgxrx106106106106+ :axbxgxrx106106106106)
         (+wl-shm.format-nv15+ :nv15)
         (+wl-shm.format-q410+ :q410)
         (+wl-shm.format-q401+ :q401)
         (+wl-shm.format-xrgb16161616+ :xrgb16161616)
         (+wl-shm.format-xbgr16161616+ :xbgr16161616)
         (+wl-shm.format-argb16161616+ :argb16161616)
         (+wl-shm.format-abgr16161616+ :abgr16161616)
         (t "Something else"))))))

(defun run ()
  (with-open-display (display)
    (let (registry shm-name)
      (setf registry (wl-display.get-registry display))
      (push (evlambda
              (:global (name interface version)
               (format t "#x~8,'0X ~32S v~D~%"
                       name interface version)
               (when (eq (a:when-let ((it (find-interface-named interface)))
                           (class-name it))
                         'wl-shm)
                 (setf shm-name name))))
            (wl-proxy-hooks registry))

      (format t "wl-registry globals:~%")
      (wl-display-roundtrip display)

      (push 'handle-shm
            (wl-proxy-hooks (wl-registry.bind registry shm-name 'wl-shm 1)))
      (format t "~%wl-shm formats:~%")
      (wl-display-roundtrip display)))
  (values))
